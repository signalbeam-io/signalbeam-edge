name: Build Edge Agent Packages

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'src/EdgeAgent/**'
      - '.github/workflows/build-edge-agent.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  PACKAGE_NAME: signalbeam-agent

jobs:
  build-packages:
    name: Build .deb packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - arch: linux-x64
            deb_arch: amd64
          - arch: linux-arm64
            deb_arch: arm64
          - arch: linux-arm
            deb_arch: armhf

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.1.0-dev.${{ github.run_number }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Restore dependencies
        run: dotnet restore src/EdgeAgent/SignalBeam.EdgeAgent.Host/SignalBeam.EdgeAgent.Host.csproj

      - name: Build and publish
        run: |
          dotnet publish src/EdgeAgent/SignalBeam.EdgeAgent.Host \
            -c Release \
            -r ${{ matrix.arch }} \
            --self-contained true \
            -p:PublishSingleFile=true \
            -p:EnableCompressionInSingleFile=true \
            -o ./publish/${{ matrix.arch }}

      - name: Create package structure
        run: |
          PACKAGE_DIR="${{ env.PACKAGE_NAME }}_${{ steps.version.outputs.VERSION }}_${{ matrix.deb_arch }}"

          # Create directory structure
          mkdir -p ${PACKAGE_DIR}/DEBIAN
          mkdir -p ${PACKAGE_DIR}/usr/local/bin
          mkdir -p ${PACKAGE_DIR}/etc/systemd/system
          mkdir -p ${PACKAGE_DIR}/usr/share/doc/${{ env.PACKAGE_NAME }}

          # Copy binary
          cp ./publish/${{ matrix.arch }}/SignalBeam.EdgeAgent.Host ${PACKAGE_DIR}/usr/local/bin/${{ env.PACKAGE_NAME }}
          chmod 755 ${PACKAGE_DIR}/usr/local/bin/${{ env.PACKAGE_NAME }}

          # Copy systemd service
          cp src/EdgeAgent/systemd/signalbeam-agent.service ${PACKAGE_DIR}/etc/systemd/system/

          # Copy documentation
          cp src/EdgeAgent/README.md ${PACKAGE_DIR}/usr/share/doc/${{ env.PACKAGE_NAME }}/
          cp src/EdgeAgent/package/INSTALL.md ${PACKAGE_DIR}/usr/share/doc/${{ env.PACKAGE_NAME }}/

          # Create copyright
          cat > ${PACKAGE_DIR}/usr/share/doc/${{ env.PACKAGE_NAME }}/copyright <<EOF
          Format: https://www.debian.org/doc/packaging-manuals/copyright-format/1.0/
          Upstream-Name: signalbeam-agent
          Source: https://github.com/signalbeam-io/signalbeam-edge

          Files: *
          Copyright: 2025 SignalBeam
          License: Proprietary
           Copyright Â© 2025 SignalBeam. All rights reserved.
          EOF

          # Create changelog
          cat > ${PACKAGE_DIR}/usr/share/doc/${{ env.PACKAGE_NAME }}/changelog.Debian <<EOF
          signalbeam-agent (${{ steps.version.outputs.VERSION }}) stable; urgency=medium

            * Release ${{ steps.version.outputs.VERSION }}

           -- SignalBeam <support@signalbeam.io>  $(date -R)
          EOF

          gzip -9 ${PACKAGE_DIR}/usr/share/doc/${{ env.PACKAGE_NAME }}/changelog.Debian

          # Copy DEBIAN control files
          cp src/EdgeAgent/package/DEBIAN/control ${PACKAGE_DIR}/DEBIAN/
          cp src/EdgeAgent/package/DEBIAN/postinst ${PACKAGE_DIR}/DEBIAN/
          cp src/EdgeAgent/package/DEBIAN/prerm ${PACKAGE_DIR}/DEBIAN/
          cp src/EdgeAgent/package/DEBIAN/postrm ${PACKAGE_DIR}/DEBIAN/

          # Update architecture and version in control file
          sed -i "s/ARCH_PLACEHOLDER/${{ matrix.deb_arch }}/g" ${PACKAGE_DIR}/DEBIAN/control
          sed -i "s/Version: .*/Version: ${{ steps.version.outputs.VERSION }}/g" ${PACKAGE_DIR}/DEBIAN/control

          # Make maintainer scripts executable
          chmod 755 ${PACKAGE_DIR}/DEBIAN/postinst
          chmod 755 ${PACKAGE_DIR}/DEBIAN/prerm
          chmod 755 ${PACKAGE_DIR}/DEBIAN/postrm

          # Calculate installed size
          INSTALLED_SIZE=$(du -sk ${PACKAGE_DIR} | cut -f1)
          echo "Installed-Size: ${INSTALLED_SIZE}" >> ${PACKAGE_DIR}/DEBIAN/control

          # Build package
          dpkg-deb --build ${PACKAGE_DIR}

          echo "PACKAGE_FILE=${PACKAGE_DIR}.deb" >> $GITHUB_ENV

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}_${{ steps.version.outputs.VERSION }}_${{ matrix.deb_arch }}
          path: ${{ env.PACKAGE_NAME }}_${{ steps.version.outputs.VERSION }}_${{ matrix.deb_arch }}.deb
          retention-days: 30

  build-docker:
    name: Build Docker image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version and tags
        id: meta
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            TAGS="ghcr.io/${{ github.repository_owner }}/edge-agent:${VERSION},ghcr.io/${{ github.repository_owner }}/edge-agent:latest"
          else
            VERSION="0.1.0-dev.${{ github.run_number }}"
            TAGS="ghcr.io/${{ github.repository_owner }}/edge-agent:dev"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAGS=$TAGS" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./src/EdgeAgent/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.TAGS }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=SignalBeam Edge Agent
            org.opencontainers.image.description=Manage edge devices from the cloud
            org.opencontainers.image.version=${{ steps.meta.outputs.VERSION }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-packages, build-docker]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Determine version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          cat > release-notes.md <<EOF
          # SignalBeam Edge Agent ${{ steps.version.outputs.VERSION }}

          ## Installation

          ### Quick Install (Debian/Ubuntu/Raspberry Pi OS)

          \`\`\`bash
          curl -fsSL https://install.signalbeam.io | sudo bash
          \`\`\`

          ### Manual Installation

          Download the appropriate package for your platform:

          - **x86_64 (Intel/AMD)**: \`signalbeam-agent_${{ steps.version.outputs.VERSION }}_amd64.deb\`
          - **ARM64 (Raspberry Pi 4/5)**: \`signalbeam-agent_${{ steps.version.outputs.VERSION }}_arm64.deb\`
          - **ARMv7 (Raspberry Pi 3)**: \`signalbeam-agent_${{ steps.version.outputs.VERSION }}_armhf.deb\`

          \`\`\`bash
          sudo dpkg -i signalbeam-agent_${{ steps.version.outputs.VERSION }}_*.deb
          \`\`\`

          ### Docker

          \`\`\`bash
          docker pull ghcr.io/${{ github.repository_owner }}/edge-agent:${{ steps.version.outputs.VERSION }}
          \`\`\`

          ## What's Changed

          See the [CHANGELOG](CHANGELOG.md) for full details.

          ## Documentation

          - [Installation Guide](src/EdgeAgent/package/INSTALL.md)
          - [systemd Service](src/EdgeAgent/systemd/README.md)
          - [Main README](src/EdgeAgent/README.md)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            ./artifacts/**/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
